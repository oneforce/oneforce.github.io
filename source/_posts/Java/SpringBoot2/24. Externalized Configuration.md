---
title: <<Spring Boot 2>> 24. Externalized Configuration
date:	2018-3-6 12:45:00
categories:	SpringBoot2
tags: [Spring Boot 2]
toc: false
comments:	false
---

Spring Boot允许您将配置外部化，以便您可以在不同环境中使用相同的应用程序代码。您可以使用属性文件，YAML文件，环境变量和命令行参数来外部化配置。属性值可以通过使用@Value注解直接注入到bean中，通过Spring的Environment抽象来访问，或者通过@ConfigurationProperties绑定到结构化对象。

Spring boot使用一个特定的重写属性值的顺序。属性按以下顺序考虑

* 在主目录上开发Devtools全局设置属性（当使用devtools时，使用`~/.spring-boot-devtools.properties`）。
* `@TestPropertySource `在你的测试类上
* `@SpringBootTest#properties` 在你的测试类属性上
* 命令行参数
* 来自SPRING_APPLICATION_JSON的属性(嵌入在环境变量或系统属性中的内联JSON`-Dspring.application.json='{"spring": {"datasource": { "url":"jdbc:mysql://localhost:3306/myapp", "username":"myappuser", "password":"mypassword" } } }' java -jar build/libs/myapp_springboot.war `)
* ServletConfig 初始化参数
* ServletContext初始化参数
* `java:comp/env`的JNDI参数
* Java 系统参数(`System.getProperties()`)
* OS环境参数
* A RandomValuePropertySource that has properties only in `random.*`.
* jar包之外的配置文件与环境相关(application-{profile}.properties和YAML文件)的应用程序属性。
* jar包之内的配置文件与环境相关(application-{profile}.properties和YAML文件)的应用程序属性。
* jar包之外的配置文件(application.properties和YAML文件)的应用程序属性。
* jar包之内的配置文件(application.properties和YAML文件)的应用程序属性。
* @Configuration类的@PropertySource注解。
* 默认属性（通过设置SpringApplication.setDefaultProperties指定）。

> 可以使用环境变量在命令行上提供SPRING_APPLICATION_JSON属性
>
> * `$ SPRING_APPLICATION_JSON='{"acme":{"name":"test"}}' java -jar myapp.jar`
> * `java -Dspring.application.json='{"name":"test"}' -jar myapp.jar`
> * `java -jar myapp.jar --spring.application.json='{"name":"test"}'`
> * `java:comp/env/spring.application.json`

## 24.1 Configuring Random Values

RandomValuePropertySource用于注入随机值（例如，注入秘密或测试用例）。它可以产生整数，长整数，uuids或字符串，如下例所示：

```
my.secret=${random.value}
my.number=${random.int}
my.bignumber=${random.long}
my.uuid=${random.uuid}
my.number.less.than.ten=${random.int(10)}
my.number.in.range=${random.int[1024,65536]}
```

## 24.2 Accessing Command Line Properties

默认情况下，SpringApplication将任何命令行选项参数（即以`--`开头的参数，例如`--server.port = 9000`）转换为属性，并将它们添加到Spring环境中。如前所述，命令行属性始终优先于其他属性源。

如果您不想将命令行属性添加到环境中，可以使用`SpringApplication.setAddCommandLineProperties（false）`将其禁用。

## 24.3 Application Property Files

SpringApplication从以下位置的application.properties文件加载属性并将它们添加到Spring环境中：

* 当前目录的`/config`子目录
* 当前目录
* classpath下的/config包
* classpath

该列表按优先顺序排列（在列表中较高的位置定义的属性会覆盖在较低位置定义的属性）。

如果您不喜欢`application.properties`作为配置文件名，则可以通过指定一个`spring.config.name`环境属性来切换到另一个文件名。您还可以使用`spring.config.location`环境属性（这是逗号分隔的目录位置或文件路径列表）引用显式位置。

```
$ java -jar myproject.jar --spring.config.name=myproject
$ java -jar myproject.jar --spring.config.location=classpath:/default.properties,classpath:/override.properties
```

如果spring.config.location包含目录(而不是文件)，则它们应该以`/`结尾(并且在运行时加载在加载之前从`spring.config.name`生成的名称，包括配置文件特定的文件名)。 Files specified in spring.config.location are used as-is, with no support for profile-specific variants, and are overridden by any profile-specific properties.

配置位置按相反顺序搜索。默认情况下，配置的位置是`classpath:/`，`classpath:/config/`，`file:./`，`file:./config/`。结果搜索顺序如下：

* `file:./ config /`
* `file:./`
* `classpath:/config/`
* `classpath:/`

当自定义`spring.config.location`，它将替换默认的config.location。例如，如果 `spring.config.location`配置成`classpath:/custom-config/,file:./custom-config/`，那么系统将会按照下面的顺序加载

* `file:./custom-config/`
* `classpath:/custom-config/`

另外，如果自定义了`spring.config.additional-location`,他们讲在默认的配置中额外使用。额外的配置路径，将优先有默认的配置路径。例如，如果`spring.config.additional-location`配置了`classpath:/custom-config/,file:./custom-config/`，那么系统查询顺序是

* `file:./custom-config/`
* `classpath:custom-config/`
* `file:./ config /`
* `file:./`
* `classpath:/config/`
* `classpath:/`

此搜索顺序可让您在一个配置文件中指定默认值，然后在另一配置文件中选择性地覆盖这些值。您可以在其中一个默认位置为application.properties中的应用程序提供默认值（或者使用spring.config.name选择的其他基本名称）。这些默认值可以在运行时被置于其中一个自定义位置的不同文件覆盖。

> 如果使用环境变量而非系统属性，则大多数操作系统不允许使用句点分隔的键名称，但可以使用下划线（例如，SPRING_CONFIG_NAME而不是spring.config.name）。

> 如果您的应用程序在容器中运行，那么可以使用JNDI属性（在`java：comp/env`中）或servlet上下文初始化参数，而不是使用环境变量或系统属性。

## 24.4 Profile-specific Properties

除了application.properties文件外，还可以使用以下命名约定来定义特定于配置文件的属性：`application-{profile}.properties`。

## 24.5 Placeholders in Properties

application.properties中的值在使用时会通过现有环境进行过滤，因此您可以返回到以前定义的值（例如，从System properties）

```
app.name=MyApp
app.description=${app.name} is a Spring Boot application
```

## 24.6 Using YAML Instead of Properties

YAML是JSON的超集，因此是用于指定分层配置数据的便利格式。SpringApplication类自动支持YAML作为属性的替代方法，只要您在类路径中具有SnakeYAML库。

### 24.6.1 Loading YAML

Spring框架提供了两个常用的类，可以用来加载YAML文档。YamlPropertiesFactoryBean将YAML加载为`properties`，YamlMapFactoryBean将YAML加载为`Map`。

例如，请考虑以下YAML文档：

```
environments:
	dev:
		url: http://dev.example.com
		name: Developer Setup
	prod:
		url: http://another.example.com
		name: My Cool App
```

将转换为以下属性：

```
environments.dev.url=http://dev.example.com
environments.dev.name=Developer Setup
environments.prod.url=http://another.example.com
environments.prod.name=My Cool App
```

YAML列表被表示为带有[index]的属性键。例如，请考虑以下YAML：

```
my:
  servers:
	  - dev.example.com
	  - another.example.com
```

将转换为以下属性：

```
my.servers[0]=dev.example.com
my.servers[1]=another.example.com
```

通过使用Spring DataBinder实用程序（这是@ConfigurationProperties的作用）绑定到类似的属性，您需要在java.util.List（或Set）类型的目标bean中拥有一个属性，并且您需要提供setter或使用可变值初始化它。例如，以下示例绑定到以前显示的属性：

```
@ConfigurationProperties(prefix="my")
public class Config {

	private List<String> servers = new ArrayList<String>();

	public List<String> getServers() {
		return this.servers;
	}
}
```

### 24.6.2 Exposing YAML as Properties in the Spring Environment

YamlPropertySourceLoader类可用于在Spring环境中将YAML作为PropertySource公开。这样做可让您使用带有占位符语法的@Value注释来访问YAML属性。

### 24.6.3 Multi-profile YAML Documents

您可以使用spring.profiles键在单个文件中指定多个配置文件特定的YAML文档，以指示文档何时适用，如以下示例所示

```
server:
	address: 192.168.1.100
---
spring:
	profiles: development
server:
	address: 127.0.0.1
---
spring:
	profiles: production
server:
	address: 192.168.1.120
```

在前面的示例中

* 如果`spring.profiles`为`development`，则server.address属性为127.0.0.1
* 如果`spring.profiles`为`production`，则server.address属性为192.168.1.120
* 如果`spring.profiles`不是`development`和`production`,则server.address属性为192.168.1.100

如果应用没用配置`spring.profiles`，则激活默认配置文件。因此，在下面的YAML中，我们为`spring.security.user.password`设置了一个值，该值仅在`default`配置文件中可用：

```
server:
  port: 8000
---
spring:
  profiles: default
  security:
    user:
      password: weak
```

而在以下示例中，由于密码未附加到任何配置文件，因此始终设置密码，必须根据需要在所有其他配置文件中明确重置该密码：

```
server:
  port: 8000
spring:
  security:
    user:
      password: weak
```

### 24.6.4 YAML Shortcomings

YAML文件不能使用@PropertySource批注加载。因此，如果您需要以这种方式加载值，则需要使用属性文件。

### 24.6.5 Merging YAML Lists
