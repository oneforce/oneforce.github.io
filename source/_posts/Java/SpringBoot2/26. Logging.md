---
title: <<Spring Boot 2>> 26. Logging
date:	2018-6-26 12:45:00
categories:	SpringBoot2
tags: [Spring Boot 2]
toc: false
comments:	false
---


Spring Boot使用Commons Logging进行所有内部日志记录，但底层是支持其他的日志系统的。对于Java Util Logging，Log4J2和Logback已提供了默认配置。日志系统都预先配置为使用控制台输出，并提供可选的文件输出。

默认情况下，如果您使用“Starters”，则使用Logback进行日志记录。还包括适当的Logback的配置，以确保使用Java Util/Commons/Log4J/SLF4J的依赖库全部正常工作。

> Java有很多可用的日志框架。如果上面的列表看起来很混乱，请不要担心。一般来说，你不需要改变你的日志依赖性，Spring Boot的默认工作就可以。

### 26.1 Log Format

Spring Boot的默认日志输出类似于以下示例：

```
2014-03-05 10:57:51.112  INFO 45469 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet Engine: Apache Tomcat/7.0.52
2014-03-05 10:57:51.253  INFO 45469 --- [ost-startStop-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
2014-03-05 10:57:51.253  INFO 45469 --- [ost-startStop-1] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in 1358 ms
2014-03-05 10:57:51.698  INFO 45469 --- [ost-startStop-1] o.s.b.c.e.ServletRegistrationBean        : Mapping servlet: 'dispatcherServlet' to [/]
2014-03-05 10:57:51.702  INFO 45469 --- [ost-startStop-1] o.s.b.c.embedded.FilterRegistrationBean  : Mapping filter: 'hiddenHttpMethodFilter' to: [/*]
```

* **Date and Time**: 毫秒精度排序。
* **Log Level**: `ERROR`, `WARN`, `INFO`, `DEBUG`, `TRACE`
* **Process ID**: 进程号
* **---** 分隔符来区分实际日志消息的开始。
* **thread name**：括在方括号中（可能会截断控制台输出）。
* **Logger name**：这通常是源类名称（通常缩写）。
* **log message**: 日志内容

## 26.2 Console Output

默认日志配置会在写入消息时将消息回传给控制台。默认情况下，将记录`ERROR`级别，`WARN`级别和`INFO`级别的消息。您还可以通过使用`--debug`标志启动应用程序来启用"debug"模式。

```
$ java -jar myapp.jar --debug
```

你也可以在`application.properties`中配置
```
debug=true
```

当启用调试模式时，核心组件（嵌入式容器，Hibernate和Spring Boot）将输出更多信息。**启用调试模式不会将应用程序配置为使用DEBUG级别记录所有消息。**

当然你也可以调用配置 `trace=true` 将核心组件的trace日志输入

### 26.2.1 Color-coded Output

如果您的终端支持ANSI，则会使用彩色输出来提高可读性。您可以通过设置`spring.output.ansi.enabled`来控制。

颜色编码通过使用％clr转换字进行配置。最简单的形式是，转换器根据日志级别为输出着色，如以下示例所示：

```
%clr(%5p)
```

表描述了日志级别到颜色的映射：

|Level|Color|
|-----|-----|
|FATAL|Red|
|ERROR|Red|
|WARN|Yellow|
|INFO|Green|
|DEBUG|Green|
|TRACE|Green|

或者，您可以通过将指定配置，转换成你需要的颜色或样式。例如，要使文本变为黄色，请使用以下设置：

```
%clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){yellow}
```

我们支持下面的样式和颜色:

* blue
* cyan
* faint
* green
* magenta
* red
* yellow

## 26.3 File Output

默认情况下，Spring Boot仅记录到控制台，不写入日志文件。如果除了控制台输出之外还想写日志文件，则需要设置`logging.file`或`logging.path`属性（例如，在application.properties中）。

下面的表格展示了logging.*属性一起使用的情况

|logging.file|logging.path|示例|说明|
|(none)|(none)||仅输出到console|
|配置了文件名|(none)|my.log|写到配置的文件名中。名称可以是确切的位置或相对于当前目录。
|(none)|配置了路径|/var/log|将spring.log写到配置的文件目录中。名称可以是确切的位置或相对于当前目录。

日志文件在达到10 MB时会轮换，并且与控制台输出一样，默认情况下会记录`ERROR`/`WARN`/`INFO`的消息。 可以使用`logging.file.max-size`属性更改大小限制。 除非已设置`logging.file.max-history`属性，否则以前轮换的文件将无限期归档。

> 日志记录系统在应用程序生命周期的早期初始化。因此，通过`@PropertySource`注释加载的属性文件中找不到日志记录属性。

> 日志记录属性独立于实际的日志记录基础结构。因此，特定的配置键（例如Logback的`logback.configurationFile`）不受Spring Boot管理。

## 26.4 Log Levels

所有支持的日志记录系统都可以使用`logging.level`设置Spring环境中的日志级别（例如，在`application.properties`中）。`<logger-name> = <level>`其中`level`是`TRACE`，`DEBUG`，`INFO`之一， `warning`/`error`/`FATAL`可以使用`logging.level.root`配置根日志级别。

下面是一些在`application.properties`的权限日志配置
```
logging.level.root=WARN
logging.level.org.springframework.web=DEBUG
logging.level.org.hibernate=ERROR
```

## 26.5 Custom Log Configuration

可以通过在类路径中包含适当的库来激活各种日志系统，并且可以通过在类路径的根目录中或在以下`Spring Environment`属性指定的位置提供合适的配置文件来进一步自定义`logging.config`。

您可以使用`org.springframework.boot.logging.LoggingSystem`系统属性强制`Spring Boot`使用特定的日志记录系统,该值应该是`LoggingSystem`实现类。 您还可以使用`none`值完全禁用Spring Boot的日志记录配置。

> 由于在创建ApplicationContext之前初始化日志记录，因此无法在Spring `@Configuration`文件中控制来自`@PropertySources`的日志记录。 更改日志记录系统或完全禁用它的唯一方法是通过系统属性。

依赖你的不同日志系统，spring会加载不同的日志配置文件

|Logging System|自定义的配置文件|
|--------------|--------------|
|Logback|`logback-spring.xml`, `logback-spring.groovy`, `logback.xml`, or `logback.groovy`|
|Log4j2|`log4j2-spring.xml`, `log4j2.xml`|
|JDK (Java Util Logging)|`logging.properties`|

> 我们建议您使用`-spring`进行日志记录配置（例如，`logback-spring.xml`而不是`logback.xml`）。如果您使用标准配置位置，则Spring无法完全控制日志初始化。

> `Java Util Logging`存在已知的类加载问题，当从“可执行jar”运行时会导致问题。如果可能的话，我们建议您从“可执行的jar”运行时避免它。

下表是Spring环境传输到系统属性

|Spring Environment|System Property|备注|
|------------------|---------------|----|
|logging.exception-conversion-word|LOG_EXCEPTION_CONVERSION_WORD|记录异常时使用的关键字|
|logging.file|LOG_FILE|如果定义，就使用默认的log配置|
|logging.file.max-size|LOG_FILE_MAX_SIZE|如果LOG_FILE定义，就定义单个日志文件的最大值（仅在logback中有效）|
|logging.file.max-history|LOG_FILE_MAX_HISTORY|如果LOG_FILE定义，就定义日志文件的最长保留历史（仅在logback中有效）|
|logging.path|LOG_PATH|如果已定义，则用于默认的日志配置|
|logging.pattern.console|CONSOLE_LOG_PATTERN|在控制台输入的日志文件格式（仅在logback中有效）|
|logging.pattern.dateformat|LOG_DATEFORMAT_PATTERN|Appender pattern for log date format.（仅在logback中有效）|
|logging.pattern.file|FILE_LOG_PATTERN|The log pattern to use in a file (if LOG_FILE is enabled). （仅在logback中有效）|
|logging.pattern.level|LOG_LEVEL_PATTERN|The format to use when rendering the log level (default %5p).（仅在logback中有效）|
|PID|PID|The current process ID (discovered if possible and when not already defined as an OS environment variable).|

所有支持的日志记录系统在分析其配置文件时都可以查阅系统属性。有关示例，请参阅spring-boot.jar中的默认配置：

* [Logback](https://github.com/spring-projects/spring-boot/blob/v2.0.3.RELEASE/spring-boot-project/spring-boot/src/main/resources/org/springframework/boot/logging/logback/defaults.xml)
* [Log4j 2](https://github.com/spring-projects/spring-boot/blob/v2.0.3.RELEASE/spring-boot-project/spring-boot/src/main/resources/org/springframework/boot/logging/log4j2/log4j2.xml)
* [Java Util logging](https://github.com/spring-projects/spring-boot/blob/v2.0.3.RELEASE/spring-boot-project/spring-boot/src/main/resources/org/springframework/boot/logging/java/logging-file.properties)

> 您可以通过仅覆盖`LOG_LEVEL_PATTERN`（或带Logback的`logging.pattern.level`）将MDC和其他临时内容添加到日志行。 例如，如果使用`logging.pattern.level = user：％X {user}％5p`，则默认日志格式包含“user”的MDC条目（如果存在），如以下示例所示。

```
2015-09-30 12:30:04.031 user:someone INFO 22174 --- [  nio-8080-exec-0] demo.Controller Handling authenticated request
```

## 26.6 Logback Extensions

Spring Boot包含许多可用于高级配置的Logback扩展。你可以在你的logback-spring.xml配置文件中使用这些扩展。

> 由于标准`logback.xml`配置文件太早加载，因此无法在其中使用扩展名。您需要使用`logback-spring.xml`或定义`logging.config`属性。

### 26.6.1 Profile-specific Configuration

我不喜欢这个profile相关的资料，就不打算翻译这块内容了:)

### 26.6.2 Environment Properties

TODO 我没理解这块内容 :(
