<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Java 9 Revealed Chapter 12 Process API | oneforce blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="stylesheet" href="https://cdn.bootcss.com/mermaid/6.0.0/mermaid.min.css"><script src="//cdn.bootcss.com/mermaid/6.0.0/mermaid.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-113549521-1','auto');ga('send','pageview');</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Java 9 Revealed Chapter 12 Process API</h1><a id="logo" href="/.">oneforce blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Java 9 Revealed Chapter 12 Process API</h1><div class="post-meta">Feb 8, 2018<span> | </span><span class="category"><a href="/categories/Java-9-Revealed/">Java 9 Revealed</a></span></div><a class="disqus-comment-count" data-disqus-identifier="2018/02/08/Java/Java 9 Revealed/Chapter 12 Process API/" href="/2018/02/08/Java/Java 9 Revealed/Chapter 12 Process API/#disqus_thread"></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一-Process-API是什么"><span class="toc-text">一. Process API是什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二-当前进程"><span class="toc-text">二. 当前进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三-查询进程状态"><span class="toc-text">三. 查询进程状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四-比较进程"><span class="toc-text">四. 比较进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五-创建进程"><span class="toc-text">五. 创建进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六-获取进程句柄"><span class="toc-text">六. 获取进程句柄</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#七-终止进程"><span class="toc-text">七. 终止进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#八-管理进程权限"><span class="toc-text">八. 管理进程权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#九-总结"><span class="toc-text">九. 总结</span></a></li></ol></div></div><div class="post-content"><p><a href="http://www.cnblogs.com/IcanFixIt/p/7214359.html" target="_blank" rel="noopener">原文地址</a></p>
<p>在本章中，主要介绍以下内容：</p>
<ul>
<li>Process API是什么</li>
<li>如何创建本地进程</li>
<li>如何获取新进程的信息</li>
<li>如何获取当前进程的信息</li>
<li>如何获取所有系统进程的信息</li>
<li>如何设置创建，查询和管理本地进程的权限</li>
</ul>
<h2 id="一-Process-API是什么"><a href="#一-Process-API是什么" class="headerlink" title="一. Process API是什么"></a>一. Process API是什么</h2><p>Process API 由接口和类组成，用来与本地进程一起工作，使用API，可以做以下事情：</p>
<ul>
<li>从Java代码中创建新的本地进程</li>
<li>获取本地进程的进程句柄，无论它们是由Java代码还是通过其他方式创建</li>
<li>销毁运行进程</li>
<li>查询活动的进程及其属性</li>
<li>获取进程的子进程和父进程的列表</li>
<li>获取本地进程的进程ID（PID）</li>
<li>获取新创建的进程的输入，输出和错误流</li>
<li>等待进程终止</li>
<li>当进程终止时执行任务</li>
</ul>
<p>Process API由java.lang包中的以下类和接口组成：</p>
<ul>
<li>Runtime</li>
<li>ProcessBuilder</li>
<li>ProcessBuilder.Redirect</li>
<li>Process</li>
<li>ProcessHandle</li>
<li>ProcessHandle.Info</li>
</ul>
<p>自Java 1.0以来，支持使用本地进程。<code>Process</code>类的实例表示由Java程序创建的本地进程。 通过调用<code>Runtime</code>类的<code>exec()</code>方法启动一个进程。</p>
<p>JDK 5.0添加了<code>ProcessBuilder</code>类，JDK 7.0添加了<code>ProcessBuilder.Redirect</code>的嵌套类。 <code>ProcessBuilder</code>类的实例保存一个进程的一组属性。 调用其<code>start()</code>方法启动本地进程并返回一个表示本地进程的Process类的实例。 可以多次调用其start()方法; 每次使用ProcessBuilder实例中保存的属性启动一个新进程。 在Java 5.0中，ProcessBuilder类接管<code>Runtime.exec()</code>方法来启动新进程。</p>
<p>在Java 7和Java 8中的Process API中有一些改进，就是在<code>Process</code>和<code>ProcessBuilder</code>类中添加几个方法。</p>
<p>在Java 9之前，Process API仍然缺乏对使用本地进程的基本支持，例如获取进程的PID和所有者，进程的开始时间，进程使用了多少CPU时间，多少本地进程正在运行等。请注意，在Java 9之前，可以启动本地进程并使用其输入，输出和错误流。 但是，无法使用未启动的本地进程，无法查询进程的详细信息。 为了更紧密地处理本地进程，Java开发人员不得不使用Java Native Interface（JNI）来编写本地代码。 Java 9使这些非常需要的功能与本地进程配合使用。</p>
<p>Java 9向Process API添加了一个名为<code>ProcessHandle</code>的接口。 <code>ProcessHandle</code>接口的实例标识一个本地进程; 它允许查询进程状态并管理进程。</p>
<p>比较<code>Process</code>类和<code>ProcessHandle</code>接口。 Process类的一个实例表示由当前Java程序启动的本地进程，而<code>ProcessHandle</code>接口的实例表示本地进程，无论是由当前Java程序启动还是以其他方式启动。 在Java 9中，已经在Process类中添加了几种方法，这些方法也可以在新的<code>ProcessHandle</code>接口中使用。 Process类包含一个返回<code>ProcessHandle</code>的<code>toHandle()</code>方法。</p>
<p><code>ProcessHandle.Info</code>接口的实例表示进程属性的快照。 请注意，进程由不同的操作系统不同地实现，因此它们的属性不同。 过程的状态可以随时更改，例如，当进程获得更多CPU时间时，进程使用的CPU时间增加。 要获取进程的最新信息，需要在需要时使用<code>ProcessHandle</code>接口的<code>info()</code>方法，这将返回一个新的ProcessHandle.Info实例。</p>
<p>本章中的所有示例都在Windows 10中运行。当使用Windows 10或其他操作系统在机器上运行这些程序时，可能会得到不同的输出。</p>
<h2 id="二-当前进程"><a href="#二-当前进程" class="headerlink" title="二. 当前进程"></a>二. 当前进程</h2><p><code>ProcessHandle</code>接口的<code>current()</code>静态方法返回当前进程的句柄。 请注意，此方法返回的当前进程始终是正在执行代码的Java进程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get the handle of the current process</span></span><br><span class="line">ProcessHandle current = ProcessHandle.current();</span><br></pre></td></tr></table></figure>
<p>获取当前进程的句柄后，可以使用ProcessHandle接口的方法获取有关进程的详细信息。</p>
<blockquote>
<p>Tips</p>
</blockquote>
<blockquote>
<p>你不能杀死当前进程。 尝试通过使用<code>ProcessHandle</code>接口的<code>destroy()</code>或<code>destroyForcibly()</code>方法来杀死当前进程会导致<code>IllegalStateException</code>异常。</p>
</blockquote>
<h2 id="三-查询进程状态"><a href="#三-查询进程状态" class="headerlink" title="三. 查询进程状态"></a>三. 查询进程状态</h2><p>可以使用<code>ProcessHandle</code>接口中的方法来查询进程的状态。 下表列出了该接口常用的简单说明方法。 请注意，许多这些方法返回执行快照时进程状态的快照。 不过，由于进程是以异步方式创建，运行和销毁的，所以当稍后使用其属性时，所以无法保证进程仍然处于相同的状态。</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>static Stream<processhandle> allProcesses()</processhandle></td>
<td>返回操作系统中当前进程可见的所有进程的快照。</td>
</tr>
<tr>
<td>Stream<processhandle> children()</processhandle></td>
<td>返回进程当前直接子进程的快照。 使用descendants()方法获取所有级别的子级列表，例如子进程，孙子进程进程等。返回当前进程可见的操作系统中的所有进程的快照。</td>
</tr>
<tr>
<td>static ProcessHandle current()</td>
<td>返回当前进程的ProcessHandle，这是执行此方法调用的Java进程。</td>
</tr>
<tr>
<td>Stream<processhandle> descendants()</processhandle></td>
<td>返回进程后代的快照。 与children()方法进行比较，该方法仅返回进程的直接后代。</td>
</tr>
<tr>
<td>boolean destroy()</td>
<td>请求进程被杀死。 如果成功请求终止进程，则返回true，否则返回false。 是否可以杀死进程取决于操作系统访问控制。</td>
</tr>
<tr>
<td>boolean destroyForcibly()</td>
<td>要求进程被强行杀死。 如果成功请求终止进程，则返回true，否则返回false。 杀死进程会立即强制终止进程，而正常终止则允许进程彻底关闭。 是否可以杀死进程取决于操作系统访问控制。</td>
</tr>
<tr>
<td>long getPid()</td>
<td>返回由操作系统分配的进程的本地进程ID（PID）。 注意，PID可以由操作系统重复使用，因此具有相同PID的两个处理句柄可能不一定代表相同的过程。</td>
</tr>
<tr>
<td>ProcessHandle.Info info()</td>
<td>返回有关进程信息的快照。</td>
</tr>
<tr>
<td>boolean isAlive()</td>
<td>如果此ProcessHandle表示的进程尚未终止，则返回true，否则返回false。 请注意，在成功请求终止进程后，此方法可能会返回一段时间，因为进程将以异步方式终止。</td>
</tr>
<tr>
<td>static Optional<processhandle> of(long pid)</processhandle></td>
<td>返回现有本地进程的Optional<processhandle>。 如果具有指定pid的进程不存在，则返回空的Optional。</processhandle></td>
</tr>
<tr>
<td>CompletableFuture <processhandle> onExit()</processhandle></td>
<td>返回一个用于终止进程的CompletableFuture<processhandle>。 可以使用返回的对象来添加在进程终止时执行的任务。 在当前进程中调用此方法会引发IllegalStateException异常。</processhandle></td>
</tr>
<tr>
<td>Optional<processhandle> parent()</processhandle></td>
<td>返回父进程的Optional<processhandle>。</processhandle></td>
</tr>
<tr>
<td>boolean supportsNormalTermination()</td>
<td>如果destroy()的实现正常终止进程，则返回true。</td>
</tr>
</tbody>
</table>
<p>下表列出ProcessHandle.Info嵌套接口的方法和描述。 此接口的实例包含有关进程的快照信息。 可以使用ProcessHandle接口或Process类的info()方法获取ProcessHandle.Info。 接口中的所有方法都返回一个Optional。</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Optional&lt;String[]&gt; arguments()</td>
<td>返回进程的参数。 该过程可能会更改启动后传递给它的原始参数。 在这种情况下，此方法返回更改的参数。</td>
</tr>
<tr>
<td>Optional<string> command()</string></td>
<td>返回进程的可执行路径名。</td>
</tr>
<tr>
<td>Optional<string> commandLine()</string></td>
<td>它是一个进程的组合命令和参数的便捷的方法。如果command()和arguments()方法都没有返回空Optional, 它通过组合从command()和arguments()方法返回的值来返回进程的命令行。</td>
</tr>
<tr>
<td>Optional<instant> startInstant()</instant></td>
<td>返回进程的开始时间。 如果操作系统没有返回开始时间，则返回一个空Optional。</td>
</tr>
<tr>
<td>Optional<duration> totalCpuDuration()</duration></td>
<td>返回进程使用的CPU时间。 请注意，进程可能运行很长时间，但可能使用很少的CPU时间。</td>
</tr>
<tr>
<td>Optional<string> user()</string></td>
<td>返回进程的用户。</td>
</tr>
</tbody>
</table>
<p>现在是时候看到<code>ProcessHandle</code>和<code>ProcessHandle.Info</code>接口的实际用法。 本章中的所有类都在<code>com.jdojo.process.api</code>模块中，其声明如下所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// module-info.java</span></span><br><span class="line"><span class="keyword">module</span> com.jdojo.process.api &#123;</span><br><span class="line">    <span class="keyword">exports</span> com.jdojo.process.api;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来包含CurrentProcessInfo类的代码。 它的<code>printInfo()</code>方法将<code>ProcessHandle</code>作为参数，并打印进程的详细信息。 我们还在其他示例中使用此方法打印进程的详细信息。main()方法获取运行进程的当前进程的句柄，这是一个Java进程，并打印其详细信息。 你可能会得到不同的输出。 以下是当程序在Windows 10上运行时生成输出。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CurrentProcessInfo.java</span></span><br><span class="line"><span class="keyword">package</span> com.jdojo.process.api;</span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.time.Instant;</span><br><span class="line"><span class="keyword">import</span> java.time.ZoneId;</span><br><span class="line"><span class="keyword">import</span> java.time.ZonedDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CurrentProcessInfo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Get the handle of the current process</span></span><br><span class="line">        ProcessHandle current = ProcessHandle.current();</span><br><span class="line">        <span class="comment">// Print the process details</span></span><br><span class="line">        printInfo(current);</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printInfo</span><span class="params">(ProcessHandle handle)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Get the process ID</span></span><br><span class="line">        <span class="keyword">long</span> pid = handle.getPid();</span><br><span class="line">        <span class="comment">// Is the process still running</span></span><br><span class="line">        <span class="keyword">boolean</span> isAlive = handle.isAlive();</span><br><span class="line">        <span class="comment">// Get other process info</span></span><br><span class="line">        ProcessHandle.Info info = handle.info();</span><br><span class="line">        String command = info.command().orElse(<span class="string">""</span>);</span><br><span class="line">        String[] args = info.arguments()</span><br><span class="line">                            .orElse(<span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">        String commandLine = info.commandLine().orElse(<span class="string">""</span>);</span><br><span class="line">        ZonedDateTime startTime = info.startInstant()</span><br><span class="line">                             .orElse(Instant.now())</span><br><span class="line">                             .atZone(ZoneId.systemDefault());</span><br><span class="line">        Duration duration = info.totalCpuDuration()</span><br><span class="line">                                .orElse(Duration.ZERO);</span><br><span class="line">        String owner = info.user().orElse(<span class="string">"Unknown"</span>);</span><br><span class="line">        <span class="keyword">long</span> childrenCount = handle.children().count();</span><br><span class="line">        <span class="comment">// Print the process details</span></span><br><span class="line">        System.out.printf(<span class="string">"PID: %d%n"</span>, pid);        </span><br><span class="line">        System.out.printf(<span class="string">"IsAlive: %b%n"</span>, isAlive);</span><br><span class="line">        System.out.printf(<span class="string">"Command: %s%n"</span>, command);</span><br><span class="line">        System.out.printf(<span class="string">"Arguments: %s%n"</span>, Arrays.toString(args));</span><br><span class="line">        System.out.printf(<span class="string">"CommandLine: %s%n"</span>, commandLine);</span><br><span class="line">        System.out.printf(<span class="string">"Start Time: %s%n"</span>, startTime);</span><br><span class="line">        System.out.printf(<span class="string">"CPU Time: %s%n"</span>, duration);</span><br><span class="line">        System.out.printf(<span class="string">"Owner: %s%n"</span>, owner);</span><br><span class="line">        System.out.printf(<span class="string">"Children Count: %d%n"</span>, childrenCount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打印输出为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PID: 8692</span><br><span class="line">IsAlive: <span class="literal">true</span></span><br><span class="line">Command: C:\java9\bin\java.exe</span><br><span class="line">Arguments: []</span><br><span class="line">CommandLine:</span><br><span class="line">Start Time: 2016-11-27T12:28:20.611-06:00[America/Chicago]</span><br><span class="line">CPU Time: PT0.296875S</span><br><span class="line">Owner: kishori\ksharan</span><br><span class="line">Children Count: 1</span><br></pre></td></tr></table></figure>
<h2 id="四-比较进程"><a href="#四-比较进程" class="headerlink" title="四. 比较进程"></a>四. 比较进程</h2><p>比较两个进程是否相等等或顺序是否相同是棘手的。 不能依赖PID来处理相同的进程。 操作系统在进程终止后重用PID。 可以与PID一起检查流程的开始时间；如果两者相同，则两个过程可能相同。 <code>ProcessHandle</code>接口的默认实现的equals()方法检查以下三个信息，以使两个进程相等：</p>
<ul>
<li>对于这两个进程，ProcessHandle接口的实现类必须相同。</li>
<li>进程必须具有相同的PID。</li>
<li>进程必须同一时间启动。</li>
</ul>
<blockquote>
<p>Tips</p>
</blockquote>
<blockquote>
<p>在<code>ProcessHandle</code>接口中使用compareTo()方法的默认实现对于排序来说并不是很有用。 它比较了两个进程的PID。</p>
</blockquote>
<h2 id="五-创建进程"><a href="#五-创建进程" class="headerlink" title="五. 创建进程"></a>五. 创建进程</h2><p>需要使用ProcessBuilder类的实例来启动一个新进程。 该类包含几个方法来设置进程的属性。 调用<code>start()</code>方法启动一个新进程。 <code>start()</code>方法返回一个Process对象，可以使用它来处理进程的输入，输出和错误流。 以下代码段创建一个<code>ProcessBuilder</code>在Windows上启动JVM：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ProcessBuilder pb = <span class="keyword">new</span> ProcessBuilder()</span><br><span class="line">                    .command(<span class="string">"C:\\java9\\bin\\java.exe"</span>,</span><br><span class="line">                             <span class="string">"--module-path"</span>,</span><br><span class="line">                             <span class="string">"myModulePath"</span>,</span><br><span class="line">                             <span class="string">"--module"</span>,</span><br><span class="line">                             <span class="string">"myModule/className"</span>)</span><br><span class="line">                    .inheritIO();</span><br></pre></td></tr></table></figure>
<p>有两种方法来设置这个新进程的命令和参数：</p>
<ul>
<li>可以将它们传递给<code>ProcessBuilder</code>类的构造函数。</li>
<li>可以使用command()方法。</li>
</ul>
<p>没有参数的<code>command()</code>方法返回在<code>ProcessBuilder</code>中命令的设置的。 带有参数的其他版本 —— 一个带有一个String的可变参数，一个带有<code>List&lt;String&gt;</code>的版本，都用于设置命令和参数。 该方法的第一个参数是命令路径，其余的是命令的参数。</p>
<p>新进程有自己的输入，输出和错误流。 inheritIO()方法将新进程的输入，输出和错误流设置为与当前进程相同。 <code>ProcessBuilder</code>类中有几个<code>redirectXxx()</code>方法可以为新进程定制标准I/O，例如将标准错误流设置为文件，因此所有错误都会记录到文件中。 配置进程的所有属性后，可以调用start()来启动进程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Start a new process</span></span><br><span class="line">Process newProcess = pb.start();</span><br></pre></td></tr></table></figure>
<p>可以多次调用<code>ProcessBuilder</code>类的<code>start()</code>方法来启动与之前保持的相同属性的多个进程。 这具有性能优势，可以创建一个ProcessBuilder实例，并重复使用它来多次启动相同的进程。</p>
<p>可以使用Process类的<code>toHandle()</code>方法获取进程的进程句柄：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get the process handle</span></span><br><span class="line">ProcessHandle handle = newProcess.toHandle();</span><br></pre></td></tr></table></figure>
<p>可以使用进程句柄来销毁进程，等待进程完成，或查询进程的状态和属性，如其子进程，后代，父进程，使用的CPU时间等。有关进程的信息，对进程的控制取决于操作系统访问控制。</p>
<p>创建可以在所有操作系统上运行的进程都很棘手。 可以创建一个新进程启动新的JVM来运行一个类。</p>
<p>如下包含一个Job类的代码。 它的<code>main()</code>方法需要两个参数：睡眠间隔和睡眠持续时间（以秒为单位）。 如果没有参数传递，该方法将使用5秒和60秒作为默认值。 在第一部分中，该方法尝试提取第一个和第二个参数（如果指定）。 在第二部分中，它使用<code>ProcessHandle.current()</code>方法获取当前进程执行此方法的进程句柄。 它读取当前进程的PID并打印包括PID，睡眠间隔和睡眠持续时间的消息。 最后，它开始一个for循环，并持续休眠睡眠间隔，直到达到睡眠持续时间。 在循环的每次迭代中，它打印一条消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Job.java</span></span><br><span class="line"><span class="keyword">package</span> com.jdojo.process.api;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * An instance of this class is used as a job that sleeps at a</span></span><br><span class="line"><span class="comment"> * regular interval up to a maximum duration. The sleep</span></span><br><span class="line"><span class="comment"> * interval in seconds can be specified as the first argument</span></span><br><span class="line"><span class="comment"> * and the sleep duration as the second argument while running.</span></span><br><span class="line"><span class="comment"> * this class. The default sleep interval and sleep duration</span></span><br><span class="line"><span class="comment"> * are 5 seconds and 60 seconds, respectively. If these values</span></span><br><span class="line"><span class="comment"> * are less than zero, zero is used instead.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Job</span> </span>&#123;</span><br><span class="line">    <span class="comment">// The job sleep interval</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DEFAULT_SLEEP_INTERVAL = <span class="number">5</span>;</span><br><span class="line">    <span class="comment">// The job sleep duration</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DEFAULT_SLEEP_DURATION = <span class="number">60</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> sleepInterval = DEFAULT_SLEEP_INTERVAL;</span><br><span class="line">        <span class="keyword">long</span> sleepDuration = DEFAULT_SLEEP_DURATION;</span><br><span class="line">        <span class="comment">// Get the passed in sleep interval</span></span><br><span class="line">        <span class="keyword">if</span> (args.length &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">            sleepInterval = parseArg(args[<span class="number">0</span>], DEFAULT_SLEEP_INTERVAL);</span><br><span class="line">            <span class="keyword">if</span> (sleepInterval &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                sleepInterval = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Get the passed in the sleep duration</span></span><br><span class="line">        <span class="keyword">if</span> (args.length &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">            sleepDuration = parseArg(args[<span class="number">1</span>], DEFAULT_SLEEP_DURATION);</span><br><span class="line">            <span class="keyword">if</span> (sleepDuration &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                sleepDuration = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> pid = ProcessHandle.current().getPid();</span><br><span class="line">        System.out.printf(<span class="string">"Job (pid=%d) info: Sleep Interval"</span> +        </span><br><span class="line">                          <span class="string">"=%d seconds, Sleep Duration=%d "</span> +  </span><br><span class="line">                          <span class="string">"seconds.%n"</span>,</span><br><span class="line">                          pid, sleepInterval, sleepDuration);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">long</span> sleptFor = <span class="number">0</span>; sleptFor &lt; sleepDuration;</span><br><span class="line">                                sleptFor += sleepInterval) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.printf(<span class="string">"Job (pid=%d) is going to"</span> +</span><br><span class="line">                                  <span class="string">" sleep for %d seconds.%n"</span>,</span><br><span class="line">                                  pid, sleepInterval);</span><br><span class="line">                <span class="comment">// Sleep for the sleep interval</span></span><br><span class="line">                TimeUnit.SECONDS.sleep(sleepInterval);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">                System.out.printf(<span class="string">"Job (pid=%d) was "</span> +</span><br><span class="line">                                  <span class="string">"interrupted.%n"</span>, pid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Starts a new JVM to run the Job class.      </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sleepInterval The sleep interval when the Job</span></span><br><span class="line"><span class="comment">     * class is run. It is passed to the JVM as the first</span></span><br><span class="line"><span class="comment">     * argument.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sleepDuration The sleep duration for the Job</span></span><br><span class="line"><span class="comment">     * class. It is passed to the JVM as the second argument.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The new process reference of the newly launched</span></span><br><span class="line"><span class="comment">     * JVM or null if the JVM cannot be launched.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Process <span class="title">startProcess</span><span class="params">(<span class="keyword">long</span> sleepInterval,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">long</span> sleepDuration)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Store the command to launch a new JVM in a</span></span><br><span class="line">        <span class="comment">// List&lt;String&gt;</span></span><br><span class="line">        List&lt;String&gt; cmd = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// Add command components in order</span></span><br><span class="line">        addJvmPath(cmd);</span><br><span class="line">        addModulePath(cmd);</span><br><span class="line">        addClassPath(cmd);</span><br><span class="line">        addMainClass(cmd);</span><br><span class="line">        <span class="comment">// Add arguments to run the class</span></span><br><span class="line">        cmd.add(String.valueOf(sleepInterval));</span><br><span class="line">        cmd.add(String.valueOf(sleepDuration));</span><br><span class="line">        <span class="comment">// Build the process attributes</span></span><br><span class="line">        ProcessBuilder pb = <span class="keyword">new</span> ProcessBuilder()</span><br><span class="line">                                .command(cmd)</span><br><span class="line">                                .inheritIO();</span><br><span class="line">        String commandLine = pb.command()</span><br><span class="line">                             .stream()</span><br><span class="line">                             .collect(Collectors.joining(<span class="string">" "</span>));</span><br><span class="line">        System.out.println(<span class="string">"Command used:\n"</span> + commandLine);</span><br><span class="line">        <span class="comment">// Start the process</span></span><br><span class="line">        Process p = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            p = pb.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Used to parse the arguments passed to the JVM, which</span></span><br><span class="line"><span class="comment">     * in turn is passed to the main() method.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> valueStr The string value of the argument</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> defaultValue The default value of the argument if</span></span><br><span class="line"><span class="comment">     * the valueStr is not an integer.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> valueStr as a long or the defaultValue if</span></span><br><span class="line"><span class="comment">     * valueStr is not an integer.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">parseArg</span><span class="params">(String valueStr,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="keyword">long</span> defaultValue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> value = defaultValue;</span><br><span class="line">        <span class="keyword">if</span> (valueStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                value = Long.parseLong(valueStr);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                <span class="comment">// no action needed</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Adds the JVM path to the command list. It first attempts</span></span><br><span class="line"><span class="comment">     * to use the command attribute of the current process;</span></span><br><span class="line"><span class="comment">     * failing that it relies on the java.home system property.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cmd The command list</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addJvmPath</span><span class="params">(List&lt;String&gt; cmd)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// First try getting the command to run the current JVM</span></span><br><span class="line">        String jvmPath = ProcessHandle.current()</span><br><span class="line">                                      .info()</span><br><span class="line">                                      .command().orElse(<span class="string">""</span>);</span><br><span class="line">        <span class="keyword">if</span>(jvmPath.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            cmd.add(jvmPath);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Try composing the JVM path using the java.home</span></span><br><span class="line">            <span class="comment">// system property</span></span><br><span class="line">            <span class="keyword">final</span> String FILE_SEPARATOR =</span><br><span class="line">                 System.getProperty(<span class="string">"file.separator"</span>);</span><br><span class="line">            jvmPath = System.getProperty(<span class="string">"java.home"</span>) +</span><br><span class="line">                                    FILE_SEPARATOR +  <span class="string">"bin"</span> +</span><br><span class="line">                                    FILE_SEPARATOR + <span class="string">"java"</span>;      </span><br><span class="line">            cmd.add(jvmPath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Adds a module path to the command list.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cmd The command list</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addModulePath</span><span class="params">(List&lt;String&gt; cmd)</span> </span>&#123;        </span><br><span class="line">        String modulePath =</span><br><span class="line">            System.getProperty(<span class="string">"jdk.module.path"</span>);</span><br><span class="line">        <span class="keyword">if</span>(modulePath != <span class="keyword">null</span> &amp;&amp; modulePath.trim().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            cmd.add(<span class="string">"--module-path"</span>);</span><br><span class="line">            cmd.add(modulePath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Adds class path to the command list.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cmd The command list</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addClassPath</span><span class="params">(List&lt;String&gt; cmd)</span> </span>&#123;        </span><br><span class="line">        String classPath = System.getProperty(<span class="string">"java.class.path"</span>);</span><br><span class="line">        <span class="keyword">if</span>(classPath != <span class="keyword">null</span> &amp;&amp; classPath.trim().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            cmd.add(<span class="string">"--class-path"</span>);</span><br><span class="line">            cmd.add(classPath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Adds a main class to the command list. Adds</span></span><br><span class="line"><span class="comment">     * module/className or just className depending on whether</span></span><br><span class="line"><span class="comment">     * the Job class was loaded in a named module or unnamed</span></span><br><span class="line"><span class="comment">     * module</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cmd The command list</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addMainClass</span><span class="params">(List&lt;String&gt; cmd)</span> </span>&#123;        </span><br><span class="line">        Class&lt;Job&gt; cls = Job<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">        String className = cls.getName();</span><br><span class="line">        Module <span class="keyword">module</span> = cls.getModule();</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">module</span>.isNamed()) &#123;</span><br><span class="line">            String moduleName = <span class="keyword">module</span>.getName();</span><br><span class="line">            cmd.add(<span class="string">"--module"</span>);</span><br><span class="line">            cmd.add(moduleName + <span class="string">"/"</span> + className);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;            </span><br><span class="line">            cmd.add(className);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Job类包含一个启动新进程的<code>startProcess(long sleepInterval，long sleepDuration)</code>方法。 它以Job类作为主类启动一个JVM。 将睡眠间隔和持续时间作为参数传递给JVM。 该方法尝试构建一个从JDK_HOME\bin目录下启动java的命令。 如果Job类被加载到一个命名的模块中，它将生成一个如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JDK_HOME\bin\java --module-path &lt;module-path&gt; --module com.jdojo.process.api/com.jdojo.process.api.Job &lt;sleepInterval&gt; &lt;sleepDuration&gt;</span><br></pre></td></tr></table></figure>
<p>如果Job类被加载到一个未命名的模块中，它将尝试构建如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JDK_HOME\bin\java -class-path &lt;class-path&gt; com.jdojo.process.api.Job &lt;sleepInterval&gt; &lt;sleepDuration&gt;</span><br></pre></td></tr></table></figure>
<p><code>startProcess()</code>方法打印用于启动进程的命令，尝试启动进程，并返回进程引用。</p>
<p><code>addJvmPath()</code>方法将JVM路径添加到命令列表中。 它尝试获取当前JVM进程的命令作为新进程的JVM路径。 如果它不可用，将尝试从java.home系统属性构建它。</p>
<p>Job类包含几个实用程序方法，用于构成命令的一部分并解析参数并传递给main()方法。 具体请参考Javadoc的说明。</p>
<p>如果要启动一个新进程，运行15秒钟并且每5秒钟唤醒，可以使用Job类的startProcess()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Start a process that runs for 15 seconds</span></span><br><span class="line">Process p = Job.startProcess(<span class="number">5</span>, <span class="number">15</span>);</span><br></pre></td></tr></table></figure>
<p>可以使用CurrentProcessInfo类的<code>printInfo()</code>方法来打印进程细节：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get the handle of the current process</span></span><br><span class="line">ProcessHandle handle = p.toHandle();</span><br><span class="line"><span class="comment">// Print the process details</span></span><br><span class="line">CurrentProcessInfo.printInfo(handle);</span><br></pre></td></tr></table></figure>
<p>当进程终止时，可以使用ProcessHandle的onExit()方法的返回值来运行任务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;ProcessHandle&gt; future = handle.onExit();</span><br><span class="line"><span class="comment">// Print a message when process terminates</span></span><br><span class="line">future.thenAccept((ProcessHandle ph) -&gt; &#123;</span><br><span class="line">    System.out.printf(<span class="string">"Job (pid=%d) terminated.%n"</span>, ph.getPid());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>可以等待新进程终止：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Wait for the process to terminate</span></span><br><span class="line">future.get();</span><br></pre></td></tr></table></figure>
<p>在这个例子中，future.get()返回进程的ProcessHandle。 没有使用返回值，因为已经在handle变量中。</p>
<p>下面包含了StartProcessTest类的代码，它显示了如何使用Job类创建一个新进程。 在<code>main()</code>方法中，它创建一个新进程，打印进程详细信息，向进程添加关闭任务，等待进程终止，并再次打印进程细节。 请注意，该进程运行15秒，但它仅使用0.359375秒的CPU时间，因为大多数时间进程的主线程正在休眠。 以下输入结果当程序在Windows 10上运行时生成输出。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StartProcessTest.java</span></span><br><span class="line"><span class="keyword">package</span> com.jdojo.process.api;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CompletableFuture;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StartProcessTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Start a process that runs for 15 seconds</span></span><br><span class="line">        Process p = Job.startProcess(<span class="number">5</span>, <span class="number">15</span>);</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Could not create a new process."</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Get the handle of the current process</span></span><br><span class="line">        ProcessHandle handle = p.toHandle();</span><br><span class="line">        <span class="comment">// Print the process details</span></span><br><span class="line">        CurrentProcessInfo.printInfo(handle);</span><br><span class="line">        CompletableFuture&lt;ProcessHandle&gt; future = handle.onExit();</span><br><span class="line">        <span class="comment">// Print a message when process terminates</span></span><br><span class="line">        future.thenAccept((ProcessHandle ph) -&gt; &#123;</span><br><span class="line">            System.out.printf(<span class="string">"Job (pid=%d) terminated.%n"</span>, ph.getPid());</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Wait for the process to complete</span></span><br><span class="line">            future.get();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Print process details again</span></span><br><span class="line">        CurrentProcessInfo.printInfo(handle);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">C:\java9\bin\java.exe --module-path</span><br><span class="line">C:\Java9Revealed\com.jdojo.process.api\build\classes --class-path</span><br><span class="line">C:\Java9Revealed\com.jdojo.process.api\build\classes --module</span><br><span class="line">com.jdojo.process.api/com.jdojo.process.api.Job 5 15</span><br><span class="line">PID: 10928</span><br><span class="line">IsAlive: <span class="literal">true</span></span><br><span class="line">Command: C:\java9\bin\java.exe</span><br><span class="line">Arguments: []</span><br><span class="line">CommandLine:</span><br><span class="line">Start Time: 2016-11-28T13:43:28.318-06:00[America/Chicago]</span><br><span class="line">CPU Time: PT0S</span><br><span class="line">Owner: kishori\ksharan</span><br><span class="line">Children Count: 1</span><br><span class="line">Job (pid=10928) info: Sleep Interval=5 seconds, Sleep Duration=15 seconds.</span><br><span class="line">Job (pid=10928) is going to sleep <span class="keyword">for</span> 5 seconds.</span><br><span class="line">Job (pid=10928) is going to sleep <span class="keyword">for</span> 5 seconds.</span><br><span class="line">Job (pid=10928) is going to sleep <span class="keyword">for</span> 5 seconds.</span><br><span class="line">Job (pid=10928) terminated.</span><br><span class="line">PID: 10928</span><br><span class="line">IsAlive: <span class="literal">false</span></span><br><span class="line">Command:</span><br><span class="line">Arguments: []</span><br><span class="line">CommandLine:</span><br><span class="line">Start Time: 2016-11-28T13:43:28.318-06:00[America/Chicago]</span><br><span class="line">CPU Time: PT0.359375S</span><br><span class="line">Owner: kishori\ksharan</span><br><span class="line">Children Count: 0</span><br></pre></td></tr></table></figure>
<h2 id="六-获取进程句柄"><a href="#六-获取进程句柄" class="headerlink" title="六. 获取进程句柄"></a>六. 获取进程句柄</h2><p>有几种方法来获取本地进程的句柄。 对于由Java代码创建的进程，可以使用Process类的<code>toHandle()</code>方法获取一个<code>ProcessHandle</code>。 本地进程也可以从JVM外部创建。 ProcessHandle接口包含以下方法来获取本地进程的句柄：</p>
<ul>
<li>static Optional<processhandle> of(long pid)</processhandle></li>
<li>static ProcessHandle current()</li>
<li>Optional<processhandle> parent()</processhandle></li>
<li>Stream<processhandle> children()</processhandle></li>
<li>Stream<processhandle> descendants()</processhandle></li>
<li>static Stream<processhandle> allProcesses()</processhandle></li>
</ul>
<p><code>of()</code>静态方法返回指定pid的<code>Optional&lt;ProcessHandle&gt;</code>。 如果没有此pid的进程，则返回一个空Optional。 要使用此方法，需要知道进程的PID：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get the process handle of the process with the pid of 1234</span></span><br><span class="line">Optional&lt;ProcessHandle&gt; handle = ProcessHandle.of(<span class="number">1234L</span>);</span><br></pre></td></tr></table></figure>
<p>静态<code>current()</code>方法返回当前进程的句柄，它始终是执行代码的Java进程。</p>
<p><code>parent()</code>方法返回父进程的句柄。 如果进程没有父进程或父进程无法检索，则返回一个空Optional。</p>
<p><code>children()</code>方法返回进程的所有直接子进程的快照。 不能保证此方法返回的进程仍然存在。 请注意，一个不存在的进程没有子进程。</p>
<p><code>descendants()</code>方法返回直接或间接进程的所有子进程的快照。</p>
<p><code>allProcesses()</code>方法返回对此进程可见的所有进程的快照。 不保证流在流处理时包含操作系统中的所有进程。</p>
<p>获取快照后，进程可能已被终止或创建。 以下代码段打印按其PID排序的所有进程的PID：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">System.out.printf(<span class="string">"All processes PIDs:%n"</span>);</span><br><span class="line">ProcessHandle.allProcesses()                    </span><br><span class="line">             .map(ph -&gt; ph.getPid())</span><br><span class="line">             .sorted()                </span><br><span class="line">             .forEach(System.out::println);</span><br></pre></td></tr></table></figure>
<p>可以为所有运行的进程计算不同类型的统计信息。 还可以在Java中创建一个任务管理器，显示一个UI，显示所有正在运行的进程及其属性。 下面代码显示了如何获得运行时间最长的进程细节以及最多使用CPU时间的进程。 比较了进程的开始时间，以获得最长的运行进程和总CPU持续时间，以获得使用CPU时间最多的进程。 你可能会得到不同的输出。 代码在Windows 10上运行程序时，得到了这个输出。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ProcessStats.java</span></span><br><span class="line"><span class="keyword">package</span> com.jdojo.process.api;</span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.time.Instant;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessStats</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">"Longest CPU User Process:%n"</span>);</span><br><span class="line">        ProcessHandle.allProcesses()</span><br><span class="line">                     .max(ProcessStats::compareCpuTime)</span><br><span class="line">                     .ifPresent(CurrentProcessInfo::printInfo);</span><br><span class="line">        System.out.printf(<span class="string">"%nLongest Running Process:%n"</span>);</span><br><span class="line">        ProcessHandle.allProcesses()</span><br><span class="line">                     .max(ProcessStats::compareStartTime)</span><br><span class="line">                     .ifPresent(CurrentProcessInfo::printInfo);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">compareCpuTime</span><span class="params">(ProcessHandle ph1,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     ProcessHandle ph2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ph1.info()</span><br><span class="line">                .totalCpuDuration()</span><br><span class="line">                .orElse(Duration.ZERO)</span><br><span class="line">                .compareTo(ph2.info()</span><br><span class="line">                        .totalCpuDuration()</span><br><span class="line">                        .orElse(Duration.ZERO));</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">compareStartTime</span><span class="params">(ProcessHandle ph1,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        ProcessHandle ph2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ph1.info()</span><br><span class="line">                .startInstant()</span><br><span class="line">                .orElse(Instant.now())</span><br><span class="line">                .compareTo(ph2.info()</span><br><span class="line">                        .startInstant()</span><br><span class="line">                        .orElse(Instant.now()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Longest CPU User Process:</span><br><span class="line">PID: 10696</span><br><span class="line">IsAlive: <span class="literal">true</span></span><br><span class="line">Command: C:\Program Files (x86)\Google\Chrome\Application\chrome.exe</span><br><span class="line">Arguments: []</span><br><span class="line">CommandLine:</span><br><span class="line">Start Time: 2016-11-28T10:12:08.537-06:00[America/Chicago]</span><br><span class="line">CPU Time: PT14M26.5S</span><br><span class="line">Owner: kishori\ksharan</span><br><span class="line">Children Count: 0</span><br><span class="line">Longest Running Process:</span><br><span class="line">PID: 0</span><br><span class="line">IsAlive: <span class="literal">false</span></span><br><span class="line">Command:</span><br><span class="line">Arguments: []</span><br><span class="line">CommandLine:</span><br><span class="line">Start Time: 2016-11-29T13:18:22.262776600-06:00[America/Chicago]</span><br><span class="line">CPU Time: PT0S</span><br><span class="line">Owner: Unknown</span><br><span class="line">Children Count: 127</span><br></pre></td></tr></table></figure>
<h2 id="七-终止进程"><a href="#七-终止进程" class="headerlink" title="七. 终止进程"></a>七. 终止进程</h2><p>可以使用<code>ProcessHandle</code>接口和<code>Process</code>类的<code>destroy()</code>或<code>destroyForcibly()</code>方法终止进程。 如果终止进程的请求成功，则两个方法都返回true，否则返回false。 <code>destroy()</code>方法请求正常终止，而<code>destroyForcibly()</code>方法请求强制终止。 在执行终止进程的请求后，<code>isAlive()</code>方法可以在短时间内返回true。</p>
<blockquote>
<p>Tips</p>
</blockquote>
<blockquote>
<p>无法终止当前进程。 调用当前进程中的<code>destroy()</code>或<code>destroyForcibly()</code>方法会引发<code>IllegalStateException</code>异常。 操作系统访问控制可能会阻止进程终止。</p>
</blockquote>
<p>一个进程的正常终止让进程彻底终止。 强制终止流程将立即终止流程。 进程是否正常终止是依赖于实现的。 可以使用<code>ProcessHandle</code>接口的supportsNormalTermination()方法和Process类来检查进程是否支持正常终止。 如果进程支持正常终止，该方法返回true，否则返回false。</p>
<p>调用这些方法来终止已经被终止的进程导致没有任何操作。 当进程结束后，<code>Process</code>类的<code>onExit()</code>返<code>CompletableFuture&lt;Process&gt;</code>，<code>ProcessHandle</code>接口的<code>onExit()</code>方法返回<code>CompletableFuture&lt;ProcessHandle&gt;</code>。</p>
<h2 id="八-管理进程权限"><a href="#八-管理进程权限" class="headerlink" title="八. 管理进程权限"></a>八. 管理进程权限</h2><p>运行上一节中的示例时，认为没有安装Java安全管理器。 如果安装了安全管理器，则需要授予适当的权限才能启动，管理和查询本地进程：</p>
<p>如果要创建新进程，则需要具有<code>FilePermission(cmd,&quot;execute&quot;)</code>权限，其中cmd是将创建进程的命令的绝对路径。 如果cmd不是绝对路径，则需要具有<code>FilePermission(&quot;&lt;&lt;ALL FILES&gt;&gt;&quot;,&quot;execute&quot;)</code>权限。</p>
<p>使用<code>ProcessHandle</code>接口中的方法来查询本地进程的状态并销毁进程，应用程序需要具有<code>RuntimePermission(&quot;manageProcess&quot;)</code>权限。<br>下面包含一个获取进程计数并创建新进程的程序。 它重复这两个任务，一个任务没有安全管理员权限，而另一个任务有安全管理员权限。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ManageProcessPermission.java</span></span><br><span class="line"><span class="keyword">package</span> com.jdojo.process.api;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ManageProcessPermission</span> </span>&#123;    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Get the process count</span></span><br><span class="line">        <span class="keyword">long</span> count = ProcessHandle.allProcesses().count();</span><br><span class="line">        System.out.printf(<span class="string">"Process Count: %d%n"</span>, count);</span><br><span class="line">        <span class="comment">// Start a new process</span></span><br><span class="line">        Process p = Job.startProcess(<span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            p.toHandle().onExit().get();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">            System.out.println(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Install a security manager</span></span><br><span class="line">        SecurityManager sm = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span>(sm == <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.setSecurityManager(<span class="keyword">new</span> SecurityManager());</span><br><span class="line">            System.out.println(<span class="string">"A security manager is installed."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Get the process count</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            count = ProcessHandle.allProcesses().count();</span><br><span class="line">            System.out.printf(<span class="string">"Process Count: %d%n"</span>, count);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(RuntimeException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Could not get a "</span> +</span><br><span class="line">                          <span class="string">"process count: "</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Start a new process</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            p = Job.startProcess(<span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line">            p.toHandle().onExit().get();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException |</span><br><span class="line">                 RuntimeException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Could not start a new "</span> +</span><br><span class="line">                               <span class="string">"process: "</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>假设没有更改任何Java策略文件，请尝试使用以下命令运行ManageProcessPermission类：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Java9Revealed&gt;java --module-path</span><br><span class="line">C:\Java9Revealed\com.jdojo.process.api\build\classes --module</span><br><span class="line">com.jdojo.process.api/com.jdojo.process.api.ManageProcessPermission</span><br></pre></td></tr></table></figure>
<p>输出结果为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Command used:</span><br><span class="line">C:\java9\bin\java.exe --module-path</span><br><span class="line">C:\Java9Revealed\com.jdojo.process.api\build\classes --module</span><br><span class="line">com.jdojo.process.api/com.jdojo.process.api.Job 1 3</span><br><span class="line">Job (pid=6320) info: Sleep Interval=1 seconds, Sleep Duration=3 seconds.</span><br><span class="line">Job (pid=6320) is going to sleep <span class="keyword">for</span> 1 seconds.</span><br><span class="line">Job (pid=6320) is going to sleep <span class="keyword">for</span> 1 seconds.</span><br><span class="line">Job (pid=6320) is going to sleep <span class="keyword">for</span> 1 seconds.</span><br><span class="line">A security manager is installed.</span><br><span class="line">Could not get a process count: access denied (<span class="string">"java.lang.RuntimePermission"</span> <span class="string">"manageProcess"</span>)</span><br><span class="line">Could not start a new process: access denied (<span class="string">"java.lang.RuntimePermission"</span> <span class="string">"manageProcess"</span>)</span><br></pre></td></tr></table></figure>
<p>你可能会得到不同的输出。 输出表示可以在安装安全管理器之前获取进程计数并创建新进程。 安装安全管理器后，Java运行时会在请求进程计数和创建新进程时抛出异常。 要解决此问题，需要授予以下四个权限：</p>
<p>“manageProcess” 运行时权限，它将允许应用程序查询本地进程并创建一个新进程。<br>在Java命令路径上“execute” 文件权限，这将允许启动JVM。<br>在系统属性“jdk.module.path”和“java.class.path”中“read”的属性权限，因此在创建命令行以启动JVM时，Job类可以读取这些属性。<br>如下包含一个脚本，将这四个权限授予所有代码。 需要将此脚本添加到计算机上的JDK_HOME\conf\security\java.policy文件中。 Java启动器的路径是C:\java9\bin\java.exe，只有在C:\java9目录中安装了JDK 9，才在Windows上有效。 对于所有其他平台和JDK安装，请修改此路径以指向计算机上正确的Java启动器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">grant &#123;</span><br><span class="line">    permission java.lang.RuntimePermission &quot;manageProcess&quot;;</span><br><span class="line">    permission java.io.FilePermission &quot;C:\\java9\\bin\\java.exe&quot;, &quot;execute&quot;;</span><br><span class="line">    permission java.util.PropertyPermission &quot;jdk.module.path&quot;, &quot;read&quot;;</span><br><span class="line">    permission java.util.PropertyPermission &quot;java.class.path&quot;, &quot;read&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>如果使用相同的命令再次运行<code>ManageProcessPermission</code>类，则应该获得类似于以下内容的输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Process Count: 133</span><br><span class="line">Command used:</span><br><span class="line">C:\java9\bin\java.exe --module-path</span><br><span class="line">C:\Java9Revealed\com.jdojo.process.api\build\classes --module</span><br><span class="line">com.jdojo.process.api/com.jdojo.process.api.Job 1 3</span><br><span class="line">Job (pid=3108) info: Sleep Interval=1 seconds, Sleep Duration=3 seconds.</span><br><span class="line">Job (pid=3108) is going to sleep for 1 seconds.</span><br><span class="line">Job (pid=3108) is going to sleep for 1 seconds.</span><br><span class="line">Job (pid=3108) is going to sleep for 1 seconds.</span><br><span class="line">A security manager is installed.</span><br><span class="line">Process Count: 133</span><br><span class="line">Command used:</span><br><span class="line">C:\java9\bin\java.exe --module-path</span><br><span class="line">C:\Java9Revealed\com.jdojo.process.api\build\classes --module</span><br><span class="line">com.jdojo.process.api/com.jdojo.process.api.Job 1 3</span><br><span class="line">Job (pid=3684) info: Sleep Interval=1 seconds, Sleep Duration=3 seconds.</span><br><span class="line">Job (pid=3684) is going to sleep for 1 seconds.</span><br><span class="line">Job (pid=3684) is going to sleep for 1 seconds .</span><br><span class="line">Job (pid=3684) is going to sleep for 1 seconds.</span><br></pre></td></tr></table></figure>
<h2 id="九-总结"><a href="#九-总结" class="headerlink" title="九. 总结"></a>九. 总结</h2><p>Process API由使用本地进程的类和接口组成。 Java SE从版本1.0通过运行时和进程类提供了Process API。 它允许创建新的本地进程，管理其I/O流并销毁它们。 Java SE的更新版本改进了API。 直到Java 9，开发人员必须诉诸编写本地代码来获取基本信息，例如进程的ID，用于启动进程的命令等。Java 9添加了一个名为ProcessHandle的接口，表示进程句柄。 可以使用进程句柄来查询和管理本地进程。</p>
<p>以下类和接口组成了Process API：<code>Runtime</code>，<code>ProcessBuilder</code>，<code>ProcessBuilder.Redirect</code>，<code>Process</code>，<code>ProcessHandle</code>和<code>ProcessHandle.Info</code>。</p>
<p>Runtime类的<code>exec()</code>方法用于启动本地进程。</p>
<p><code>ProcessBuilder</code>类的<code>start()</code>方法是优先于Runtime类的<code>exec()</code>方法来启动进程。 <code>ProcessBuilder.Redirect</code>类的实例表示进程的进程输入源或进程的目标输出。</p>
<p><code>Process</code>类的实例表示由Java程序创建的本地进程。</p>
<p><code>ProcessHandle</code>接口的实例表示由Java程序或其他方式创建的进程。它在Java 9中添加，并提供了几种方法来查询和管理进程。 <code>ProcessHandle.Info</code>接口的实例表示进程的快照信息; 它可以使用<code>Process</code>类或<code>ProcessHandle</code>接口的<code>info()</code>方法获得。 如果有一个进程实例，使用它的<code>toHandle()</code>方法获得一个<code>ProcessHandle</code>。</p>
<p><code>ProcessHandle</code>接口的<code>onExit()</code>方法返回一个用于终止进程的<code>CompletableFuture&lt;ProcessHandle&gt;</code>。 可以使用返回的对象来添加在进程终止时执行的任务。 请注意，不能在当前进程中使用此方法。</p>
<p>如果安装了一个安全管理器，则应用程序需要有一个“manageProcess”运行时权限来查询和管理本地进程，并在Java代码启动的进程的命令文件上“execute” 文件权限。</p>
</div><p class="readmore"><a href="http://blog.oneforce.cn/online-markdown/?path=https://raw.githubusercontent.com/oneforce/oneforce.github.io/blog/source/_posts/Java/Java 9 Revealed/Chapter 12 Process API.md">在微信markdown中展示</a></p><div class="tags"><a href="/tags/Java9/">Java9</a><a href="/tags/jshell/">jshell</a></div><div class="post-nav"><a class="pre" href="/2018/02/08/Java/Java 9 Revealed/Chapter 11 JSHELL/">Java Revealed Chapter JShell</a><a class="next" href="/2018/02/08/Java/Java 9 Revealed/Chapter 13 Collection API/">Java Revealed Chapter 13 Collection API</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank"><input type="search" name="word" maxlength="20" placeholder="Search"><input type="hidden" name="si" value="https://oneforce.github.io"><input name="tn" type="hidden" value="bds"><input name="cl" type="hidden" value="3"><input name="ct" type="hidden" value="2097152"><input name="s" type="hidden" value="on"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java-9-Revealed/">Java 9 Revealed</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java-Revealed/">Java Revealed</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringBoot2/">SpringBoot2</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/spring/">spring</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/参考文档/">参考文档</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/征信/">征信</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/私募基金/">私募基金</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/资产管理/">资产管理</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/金融法规/">金融法规</a><span class="category-list-count">15</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/入门系列/" style="font-size: 15px;">入门系列</a> <a href="/tags/tool/" style="font-size: 15px;">tool</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/spring-boot/" style="font-size: 15px;">spring boot</a> <a href="/tags/合规/" style="font-size: 15px;">合规</a> <a href="/tags/征信/" style="font-size: 15px;">征信</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/utf8/" style="font-size: 15px;">utf8</a> <a href="/tags/字符集/" style="font-size: 15px;">字符集</a> <a href="/tags/上海/" style="font-size: 15px;">上海</a> <a href="/tags/汽车/" style="font-size: 15px;">汽车</a> <a href="/tags/读书笔记/" style="font-size: 15px;">读书笔记</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/svn/" style="font-size: 15px;">svn</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/金融/" style="font-size: 15px;">金融</a> <a href="/tags/上海市互联网金融行业协会/" style="font-size: 15px;">上海市互联网金融行业协会</a> <a href="/tags/网络借贷/" style="font-size: 15px;">网络借贷</a> <a href="/tags/P2P/" style="font-size: 15px;">P2P</a> <a href="/tags/金融办/" style="font-size: 15px;">金融办</a> <a href="/tags/2018/" style="font-size: 15px;">2018</a> <a href="/tags/指引/" style="font-size: 15px;">指引</a> <a href="/tags/电子合同存证/" style="font-size: 15px;">电子合同存证</a> <a href="/tags/金融科技/" style="font-size: 15px;">金融科技</a> <a href="/tags/银监会/" style="font-size: 15px;">银监会</a> <a href="/tags/资产管理/" style="font-size: 15px;">资产管理</a> <a href="/tags/现金贷/" style="font-size: 15px;">现金贷</a> <a href="/tags/Java9/" style="font-size: 15px;">Java9</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/stream/" style="font-size: 15px;">stream</a> <a href="/tags/long/" style="font-size: 15px;">long</a> <a href="/tags/Spring-Boot-2/" style="font-size: 15px;">Spring Boot 2</a> <a href="/tags/springboot/" style="font-size: 15px;">springboot</a> <a href="/tags/原则/" style="font-size: 15px;">原则</a> <a href="/tags/zookeeper/" style="font-size: 15px;">zookeeper</a> <a href="/tags/架构/" style="font-size: 15px;">架构</a> <a href="/tags/p2p/" style="font-size: 15px;">p2p</a> <a href="/tags/代收/" style="font-size: 15px;">代收</a> <a href="/tags/央行/" style="font-size: 15px;">央行</a> <a href="/tags/证监会/" style="font-size: 15px;">证监会</a> <a href="/tags/私募基金/" style="font-size: 15px;">私募基金</a> <a href="/tags/PE/" style="font-size: 15px;">PE</a> <a href="/tags/委托贷款/" style="font-size: 15px;">委托贷款</a> <a href="/tags/私募/" style="font-size: 15px;">私募</a> <a href="/tags/jshell/" style="font-size: 15px;">jshell</a> <a href="/tags/collection/" style="font-size: 15px;">collection</a> <a href="/tags/lambda/" style="font-size: 15px;">lambda</a> <a href="/tags/http-2/" style="font-size: 15px;">http/2</a> <a href="/tags/fabric/" style="font-size: 15px;">fabric</a> <a href="/tags/SVN/" style="font-size: 15px;">SVN</a> <a href="/tags/说明文档/" style="font-size: 15px;">说明文档</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2023/10/05/金融/促进金融科技发展 支持上海建设金融科技中心/">金融/促进金融科技发展 支持上海建设金融科技中心</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/10/05/技术杂项/字符集和字符编码/">技术杂项/字符集和字符编码</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/13/说明/常用正则/">常用正则</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/26/技术杂项/架构/架构在做什么1/">架构在做什么1</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/02/金融/中国人民银行/中国人民银行关于规范代收业务的通知/">中国人民银行关于规范代收业务的通知 (征求意见稿)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/02/金融/中国人民银行/中国人民银行关于规范代收业务 的通知（征求意见稿）》主要问题说明/">《中国人民银行关于规范代收业务的通知（征求意见稿）》主要问题说明</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/21/找书途径及下载方法/">找书途径及下载方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/30/金融/促进金融科技发展支持上海建设金融科技中心/">促进金融科技发展 支持上海建设金融科技中心</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/25/技术杂项/spring/设置context-path不能被服务发现的问题/">设置context-path不能被服务发现的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/21/金融/关于办理非法放贷刑事案件若干问题的意见/">关于办理非法放贷刑事案件若干问题的意见</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//oneforce-github-io.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2023 <a href="/." rel="nofollow">oneforce blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = '//hm.baidu.com/hm.js?' + '718da94a7cf34af2eac95661ab1fc06f';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script><script>(function () {
  var bp = document.createElement('script');
  bp.src = '//push.zhanzhang.baidu.com/push.js';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>